<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multiboard Sync Service</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="header">
    <h1>Multiboard Database Sync Service</h1>
  </header>

  <div class="container">
    <h2>Database Utilities</h2>
    <div class="actions">
      <button class="btn" onclick="listDatabases()">List Databases</button>
      <button class="btn" onclick="testConnection('production')">Test Production</button>
      <button class="btn" onclick="testConnection('staging')">Test Staging</button>
      <button class="btn" onclick="testConnection('dev')">Test Dev</button>
      <button class="btn" onclick="testConnection('localhost')">Test Localhost</button>
    </div>
    <div id="results" class="results"></div>
  </div>

  <div class="container">
    <h2>Export</h2>
    <div class="actions">
      <button class="btn" onclick="startExport('localhost')">Export Localhost</button>
      <button class="btn" onclick="startExport('dev')">Export Dev</button>
    </div>

    <h3>Jobs</h3>
    <div id="jobs" class="jobs"></div>
  </div>

  <div class="container">
    <h2>Database Sync</h2>
    <div class="form-row">
      <label>Source:
        <select id="source">
          <option value="dev">Dev</option>
          <option value="staging">Staging</option>
        </select>
      </label>
      <label>Target:
        <select id="target">
          <option value="localhost">Localhost</option>
        </select>
      </label>
      <button class="btn" onclick="syncDB()">Start Sync</button>
    </div>
    <div id="sync-progress" class="sync-progress"></div>
  </div>

  <script>
    async function listDatabases() {
      const resp = await fetch('/api/databases');
      const data = await resp.json();
      document.getElementById('results').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    async function testConnection(db) {
      const resp = await fetch('/api/databases/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({database: db})
      });
      const data = await resp.json();
      document.getElementById('results').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    async function startExport(db) {
      try {
        const res = await fetch('/api/sync/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ database: db })
        });
        if (!res.ok) {
          const t = await res.text();
          alert('Failed: ' + t);
          return;
        }
        const data = await res.json();
        alert('Job queued: ' + data.jobId);
        refreshJobs();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function refreshJobs() {
      try {
        const res = await fetch('/api/jobs');
        const jobs = await res.json();
        const el = document.getElementById('jobs');
        el.innerHTML = '';
        const list = document.createElement('ul');
        jobs.forEach(j => {
          const li = document.createElement('li');
          li.classList.add('job-item');
          if (j.status === 'completed') li.classList.add('status-completed');
          else if (j.status === 'failed') li.classList.add('status-failed');
          else li.classList.add('status-running');

          const title = document.createElement('div');
          title.textContent = `${j.id} [${j.database}] - ${j.status}`;
          title.style.marginBottom = '6px';
          li.appendChild(title);

          const container = document.createElement('div');
          container.className = 'progress-container';

          const bar = document.createElement('div');
          bar.className = 'progress-bar' + (j.status === 'completed' ? ' completed' : '');
          const pct = Math.max(0, Math.min(100, Number(j.progress || 0)));
          bar.style.width = pct + '%';

          const text = document.createElement('span');
          text.className = 'progress-text';
          text.textContent = pct + '%';

          bar.appendChild(text);
          container.appendChild(bar);
          li.appendChild(container);

          list.appendChild(li);
        });
        el.appendChild(list);
      } catch (e) {
        console.error(e);
      }
    }

    async function syncDB() {
      const source = document.getElementById('source').value;
      const target = document.getElementById('target').value;
      try {
        const res = await fetch('/api/sync/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, target })
        });
        if (!res.ok) {
          const t = await res.text();
          alert('Failed: ' + t);
          return;
        }
        const data = await res.json();
        const jobId = data.jobId;
        const progressEl = document.getElementById('sync-progress');

        const wrapper = document.createElement('div');
        wrapper.className = 'sync-progress job-item status-running';

        const title = document.createElement('div');
        title.textContent = 'Queued (job ' + jobId + ')';
        title.style.marginBottom = '6px';
        wrapper.appendChild(title);

        const container = document.createElement('div');
        container.className = 'progress-container';

        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        bar.style.width = '0%';

        const text = document.createElement('span');
        text.className = 'progress-text';
        text.textContent = '0%';

        bar.appendChild(text);
        container.appendChild(bar);
        wrapper.appendChild(container);

        progressEl.innerHTML = '';
        progressEl.appendChild(wrapper);

        const interval = setInterval(async () => {
          try {
            const jr = await fetch('/api/jobs/' + jobId);
            if (!jr.ok) return;
            const j = await jr.json();

            wrapper.className = 'sync-progress job-item ' + (j.status === 'completed' ? 'status-completed' : (j.status === 'failed' ? 'status-failed' : 'status-running'));
            title.textContent = `Job ${j.id} [${j.database}] - ${j.status}`;
            const pct = Math.max(0, Math.min(100, Number(j.progress || 0)));
            bar.style.width = pct + '%';
            if (j.status === 'completed') {
              bar.classList.add('completed');
            }
            text.textContent = pct + '%';

            if (j.status === 'completed' || j.status === 'failed') {
              clearInterval(interval);
            }
          } catch (e) {
            console.error(e);
          }
        }, 1000);
        refreshJobs();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    setInterval(refreshJobs, 2000);
    refreshJobs();
  </script>
</body>
</html>
