<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multiboard Sync Service</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
    button { padding: 10px 16px; margin: 6px; cursor: pointer; }
    ul { padding-left: 1.2rem; }
    li { margin: 0.25rem 0; }
    .section { margin-bottom: 28px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Multiboard Database Sync Service</h1>

  <div class="section">
    <h2>Database Utilities</h2>
    <button onclick="listDatabases()">List Databases</button>
    <button onclick="testConnection('production')">Test Production</button>
    <button onclick="testConnection('staging')">Test Staging</button>
    <button onclick="testConnection('dev')">Test Dev</button>
    <button onclick="testConnection('localhost')">Test Localhost</button>
    <div id="results"></div>
  </div>

  <div class="section">
    <h2>Export</h2>
    <button onclick="startExport('localhost')">Export Localhost</button>
    <button onclick="startExport('dev')">Export Dev</button>

    <h3>Jobs</h3>
    <div id="jobs"></div>
  </div>

  <div class="section">
    <h2>Database Sync</h2>
    <label>Source:
      <select id="source">
        <option value="dev">Dev</option>
        <option value="staging">Staging</option>
      </select>
    </label>
    <label>Target:
      <select id="target">
        <option value="localhost">Localhost</option>
      </select>
    </label>
    <button onclick="syncDB()">Start Sync</button>
    <div id="sync-progress"></div>
  </div>

  <script>
    async function listDatabases() {
      const resp = await fetch('/api/databases');
      const data = await resp.json();
      document.getElementById('results').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    async function testConnection(db) {
      const resp = await fetch('/api/databases/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({database: db})
      });
      const data = await resp.json();
      document.getElementById('results').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    async function startExport(db) {
      try {
        const res = await fetch('/api/sync/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ database: db })
        });
        if (!res.ok) {
          const t = await res.text();
          alert('Failed: ' + t);
          return;
        }
        const data = await res.json();
        alert('Job queued: ' + data.jobId);
        refreshJobs();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function refreshJobs() {
      try {
        const res = await fetch('/api/jobs');
        const jobs = await res.json();
        const el = document.getElementById('jobs');
        el.innerHTML = '';
        const list = document.createElement('ul');
        jobs.forEach(j => {
          const li = document.createElement('li');
          li.textContent = `${j.id} [${j.database}] - ${j.status} - ${j.progress}%`;
          list.appendChild(li);
        });
        el.appendChild(list);
      } catch (e) {
        console.error(e);
      }
    }

    async function syncDB() {
      const source = document.getElementById('source').value;
      const target = document.getElementById('target').value;
      try {
        const res = await fetch('/api/sync/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, target })
        });
        if (!res.ok) {
          const t = await res.text();
          alert('Failed: ' + t);
          return;
        }
        const data = await res.json();
        const jobId = data.jobId;
        const progressEl = document.getElementById('sync-progress');
        progressEl.textContent = 'Queued (job ' + jobId + ')';
        const interval = setInterval(async () => {
          try {
            const jr = await fetch('/api/jobs/' + jobId);
            if (!jr.ok) return;
            const j = await jr.json();
            progressEl.textContent = `Job ${j.id} [${j.database}] - ${j.status} - ${j.progress}%`;
            if (j.status === 'completed' || j.status === 'failed') {
              clearInterval(interval);
            }
          } catch (e) {
            console.error(e);
          }
        }, 1000);
        refreshJobs();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    setInterval(refreshJobs, 2000);
    refreshJobs();
  </script>
</body>
</html>
